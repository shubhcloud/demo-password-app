name: Update Helm Values with Image Tag

on:
  workflow_run:
    workflows: ["Build & Push Docker Image to ACR"]
    types: [completed]
    branches: [main]

permissions:
  contents: write

env:
  VALUES_FILE: password-app/values.yaml

jobs:
  update-helm:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout helm-update branch
        uses: actions/checkout@v6
        with:
          ref: helm-update

      # Extract same short SHA used in image workflow
      - name: Set and update image tag
        run: |
          echo "TAG=${{ github.event.workflow_run.head_sha }}"
          echo "TAG=${TAG::5}" >> $GITHUB_ENV
          sed -i 's|tag: .*|tag: '"$TAG"'|g' $VALUES_FILE

      - name: Commit changes to helm-update branch
        run: |
          git config user.name "gha-helm-iamge-update"
          git config user.email "actions@github.com"

          git add $VALUES_FILE
          git commit -m "chore: update image tag to $TAG" || echo "No changes"

          git push origin helm-update

      - name: Create PR helm-update â†’ main
        env: 
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            if gh pr list --head helm-update --base main --json number --jq 'length' | grep -q '^0$'; then
            gh pr create \
              --title "Update image tag to $TAG" \
              --body "Auto update Helm image tag to $TAG after image build." \
              --base main \
              --head helm-update
            echo "PR created"
            else
              echo "PR already exists"
            fi